{% extends '../base.html' %}

{% block content %}
<section class="row">
    <div class="col-xl-12">
        <section class="hk-sec-wrapper">
            <h5 class="hk-sec-title">Gestión de denuncias</h5>

            <hr>
            {% if form.errors %}
            <div class="alert alert-warning" role="alert">
              {{ form.errors }}
            </div>
            {% endif %}
            <form method="post">
                {% csrf_token %}
                <h6 class="form-group">Datos de los tendero(s) involucrado(s)</h6>
                <div class="row">
                    <div class="col-sm">
                        <div class="row">
                            <div class="col-md-12 form-group">
                                <label for="id_tendero">Seleccionar/ Gestionar tendero(s)</label>
                                {{form.tendero}}
                            </div>
                            <div class="col-md-12 form-group">
                                {% if form.hechos.value != None %}
                                <textarea class="form-control mt-15" rows="4" placeholder="Narrar los echos" name="hechos">{{form.hechos.value}}</textarea>
                                {% else %}
                                <textarea class="form-control mt-15" rows="4" placeholder="Narrar los echos" name="hechos"></textarea>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>
                <hr>
                <h6 class="form-group">Datos de la tienda y otros</h6>
                <div class="row">
                    <!--<div class="col-lg-6 col-sm-6 form-group">
                        <label for="pregunta">Seleccionar el/ los producto(s)</label>
                        {{form.producto}}
                    </div>-->
                    <div class="col-lg-6 col-sm-6 form-group">
                        <label for="tienda">Seleccionar la tienda</label>
                        {{form.tienda}}
                    </div>
                    <div class="col-lg-6 col-sm-6 form-group">
                        <label for="modalidad">Modalidad</label>
                        {{form.modalidad}}
                    </div>
                    <div class="col-lg-6 col-sm-6 form-group">
                        <label for="clase">Clase</label>
                        {{form.clase}}
                    </div>
                </div>
                <hr>

                <div class="row justify-content-end">
                    <div class="col-sm-12-8 col-lg-10">
                        <h6 class="form-group">Productos(s)</h6>
                    </div>
                    <div class="col-sm-4 col-lg-2 text-center text-blue" style="cursor: pointer" onclick="addProduct()">
                        <i class="fa fa-plus-circle" style="font-size: 18pt"></i>
                    </div>
                </div>

                <table class="table table-dark">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="body-table">
                    {% for producto in producto_denunciados %}
                        <tr id="{{producto.id}}">
                            <td>{{producto.producto.nombre}}</td>
                            <td>{{producto.cantidad}}</td>
                            <td>
                                <div class="btn-primary rounded-8 text-center" onclick="deleteProduct({{producto.id}})">
                                    <i class="fa fa-trash"></i>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <input type="hidden" id="productos_seleccionados" name="productos_seleccionados">
                <button class="btn btn-danger" type="submit">Guardar información de la denuncia</button>
                <a href="/gestion/denuncias/registrar" class="btn-primary btn"> Nuevo</a>
                <a href="/gestion/denuncias/listado" class="btn-success btn"> Listado</a>
            </form>
        </section>
    </div>
</section>
{% endblock %}
{% block modal %}
    <div id="modal-product" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Productos</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
            <div class="modal-body">
                <form id="form-product">
                    <div class="form-group">
                        <label>Productos:</label>
                        <select id="producto" class="form-control selectpicker">
                            <option value="" selected>---------</option>
                            {% for producto in productos %}
                            <option value = "{{producto.id}}" data-name = "{{producto.nombre}}">{{producto.nombre}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad:</label>
                        <input type="text" id="cantidad" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="makeAddProduct">Agregar</button>
            </div>
            </div>

        </div>
    </div>
{% endblock %}
{% block js %}
<script>
    var jsonProduct = [];
    $(function(){
        {% for producto in producto_denunciados %}
            jsonProduct.push({
                id:'{{producto.id}}',
                producto: '{{producto.producto.id}}',
                cantidad: '{{producto.cantidad}}',
            });
        {% endfor %}
        console.log(JSON.stringify(jsonProduct));
        $('#makeAddProduct').click(function(){
            if ($('#producto').val() == "") {
                toastr.warning("Por favor seleccione un producto");
                return;
            }
            if ($('#cantidad').val() == "") {
                toastr.warning("Por favor ingrese una cantidad");
                return;
            }
            var idRound = Math.floor((Math.random() * 999) + 100);
            var xTable = "<tr id='"+idRound+"'>" +
                "<td>"+$('select[id=producto] option').filter(':selected').text()+"</td>" +
                "<td>" + $('#cantidad').val()+"</td>" +
                "<td><div class=\"btn-primary rounded-8 text-center\" onclick=\"deleteProduct("+idRound+")\">\n" +
                "                                    <i class=\"fa fa-trash\"></i>\n" +
                "                                </div></td>" +
            "</tr>";
            $('#body-table').append(xTable);
            jsonProduct.push({
                id: idRound,
                producto: $('#producto').val(),
                cantidad: $('#cantidad').val(),
            });
            $('#productos_seleccionados').val( JSON.stringify(jsonProduct));
            $('#cantidad').val("");
        });
    });
    function addProduct() {
        $('#modal-product').modal('show');
    }

    function deleteProduct(product_id) {
        for (const key in jsonProduct) {
          const element = jsonProduct[key];
          if (product_id == element.id) {
            jsonProduct.splice(Number(key), 1);
            $('#' + product_id).remove();
            $('#productos_seleccionados').val( JSON.stringify(jsonProduct));
          }
        }
    }
</script>
{% endblock %}